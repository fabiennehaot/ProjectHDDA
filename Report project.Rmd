---
title: "HDDA Project"
author: "L. Barbier, K. De Witte, F. Haot, K. Putseys"
date: "12/16/2021"
bibliography: references.bib
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(gridExtra)
library(HDDAData)
library(glmnet)
library(MASS)
library(locfdr)
library(boot)
library(pROC)
```

# Research Question

# Executive Summary

# Technical Report

## Data

Data description in [@einecke:2010]
```{r getdata}
data("Einecke2010Kidney")
X_raw <- Einecke2010Kidney[, -1]
Y <- factor(Einecke2010Kidney[, 1], 
            levels = c(0,1),labels = c('accept','reject'))
```

## Exploration of the Data

## Hypothesis Testing 


Not every gene in the data set is an indicator for kidney rejection. In this section we find out which genes are differentially expressed between the two kidney rejection groups. Since we do not know a priori whether differentiated genes will show higher or lower intensities we opt for 2 sided t-tests with unequal variances. 

\[H_0: \mu_{normal}(gene) = \mu_{reject}(gene) \]
\[H_1: \mu_{normal}(gene) \neq \mu_{reject}(gene) \]

We first perform these t-tests for every gene in the data, with an individual significance level of 5%. Because we are performing multiple testing we would expect to find about 500 genes with a p-value lower than 5% if the null hypothesis holds for all the genes. 

```{r hyptest_unadjusted, fig.height= 4}
gene_data <- as.matrix(X_raw)
group <- Y
# non adjusted p-values as named vector
significance_level <- 0.05
ttest_results <- apply(gene_data, 2, function(x) {
  t_test <- t.test(x ~ group)
  p_val <- t_test$p.value
  stat <- t_test$statistic
  df <- t_test$parameter
  z_val <- case_when(stat < 0 ~ qnorm(p_val/2), TRUE~ qnorm(1-p_val/2))
  tibble(stat= stat, p_val = p_val,z_val = z_val, df = df)})
t_stats <- bind_rows(ttest_results) %>%
  mutate(gene = colnames(X_raw),
         isdetected_t = factor(p_val < significance_level,
                         levels=c(TRUE, FALSE),
                         labels = c('detected','H0 not rejected')))

# plot histogram for the unadjusted z-values
mean_z <- round(mean(t_stats$z_val),3) 
sd_z <- round(sd(t_stats$z_val),3) 

ggplot(data=t_stats) + 
  geom_histogram(mapping=aes(x = z_val,fill=isdetected_t),bins=20,alpha = .7)+
  scale_fill_manual(values=c("firebrick","lightblue")) +
  labs(title = "multiple t-tests",
       subtitle="histogram of transformed z-values",
       x = "z-values")+
  annotate(geom="text", x=-8, y=1500, 
           label=paste0("mean: ", mean_z,"\nstdev:", sd_z))+
  theme_bw()

# number and names of differentiated genes
table_p_nonadj <- table(t_stats$p_val < 0.05)
nonadj_diff_genes <- t_stats %>% filter(p_val<.05) %>% .$gene
```

There are `r as.numeric(table_p_nonadj['TRUE'])` out of 10000 genes with unadjusted p-value below 0.05, while we expected to find 500 genes if the null hypothesis were true for all the genes.  

The histogram does not show a standard normal distribution as the observations are skewed to the left. We can derive from this histogram that the differentiated genes tend to have higher intensities in the group with rejected kidneys. There is also reason to assume that the non-differentiated genes give rise to a null distribution which is not standard normal.


```{r hyptest_fdr_hist}
#fdr analysis - current behaviour of p-values: uniform?
t_stats %>%
  ggplot(aes(x = p_val)) +
  geom_histogram(fill = "firebrick",breaks = seq(0,1,.05),alpha=.7)+
  labs(title = 'histogram of p-values')+
  theme_bw()
```

This histogram should show a distribution which is close to a uniform distribution
for the larger p-values, but with higher frequencies for the smallest p-values.
The higher number of genes with small p-values indicate in that situation that some genes show a different behaviour regarding kidney rejection. 

We see a more of less constant frequency for p-values higher than 35%, we also see a clear peak for p-values lower than 5% but the frequencies for values between 5% and 35% are not constant. The assumption of a standard normal null distribution is not valid. Because of this we underestimate the lower tail of the non differentiated genes with respect to the rejection status. We will scale the z values to a standard normal distribution and recalculate the associated p-values. 

We will also adjust for multiple testing by controlling the false detection ratio (FDR = 10%): the list with detected genes will contain false positives, but the ratio of the truly differentiated detected genes and all the detected genes is expected to be 90%. The p-values are adjusted using the Benjamini and Hochberg[@BH:1995] procedure. 

```{r hyptest_fdr_padj}
# adjusted p values
fdr_level <- 0.1
t_stats <- t_stats %>%
  mutate(z_scale = (z_val - mean(z_val))/sd(z_val),
         p_scale = pnorm(z_scale),
         p_adj = p.adjust(p_scale, method="fdr"),
         isdetected_fdr = factor(p_adj< fdr_level,
                         levels=c(TRUE,FALSE),
                         labels = c('detected','H0 not rejected')))

# monotonous transformation:
pp_adj <- t_stats %>%
  ggplot(aes(x=p_scale,y=p_adj)) +
  geom_point(size = .3,color='red') +
  geom_segment(x=0,y=0,xend=1,yend=1) +
  labs(y= "adjusted p-value (BH, 1995)") +
  theme_bw()

# right plot removes observations with high fdr 
suppressWarnings(
  grid.arrange(pp_adj,
             pp_adj + ylim(c(0,fdr_level)),
             ncol=2))

# these are the detected genes and a histogram of their t-values
table_p_adj <- table(t_stats$p_adj < fdr_level)
nr_detected_fdr <- as.numeric(table_p_adj['TRUE'])
fdr_genes <- t_stats %>% filter(p_adj < fdr_level)%>% .$gene
ggplot(t_stats) + 
  scale_fill_manual(values=c("firebrick","lightblue")) +
  geom_histogram(mapping=aes(x = stat, fill=isdetected_fdr), bins = 20,alpha=.7)+
  labs(title= 't-statistics for differentiated genes FDR',
       subtitle = ' p-values, rescaled and adjusted for multiple testing')+
  theme_bw()            
  
```

The scaling has lowerd the number of candidate genes drastically.
There are now `r nr_detected_fdr` out of 10000 genes with adjusted p-value below 10%. We still expect `r round(nr_detected_fdr/10,-1)` of these genes to be false detections. 

All of the detected genes are found in the lower tail, which seems acceptable. The histogram of the non selected genes is still skewed to the left however. The histogram also gives the impression that we should have gotten more differenciated genes.

We will try to make a better list using a local approach where we assume that the observed histogram represents a mixture of different Gaussian distributions, each with their own mean and standard deviance. We will use the z-values before scaling for this part. The means and standard deviance of the different distributions will be calculated using maximum likelihood.



```{r localfdr}
#local fdr
fdr_x <- locfdr(t_stats$z_val,plot=4) 
prop_h0 <- fdr_x$fp0['mlest','p0']
```

The left plot shows the density of both population. The proportion of differentiated genes is expected to be`r round(100*(1 - prop_h0),2)` percent. This means `r round(10000*(1 - prop_h0),0)`genes for our data set. The blue line represents the null distribution, the purple bars represent the differentiated genes. We do not expect to find signal genes with high t-values. 

The second plot shows the local false discovery rate. Since we want to control the FDR we are more interested in the red dashed line, which represents the left FDR-graph with the FDR for all the genes in the left tail of the empirical distribution. The Efdr represents the expected local fdr for a typical non-null feature, i.e. the mean local fdr, weighted with the density represented by all the purple bars.


```{r control_lfdr}

FDR_left <- fdr_x$mat[,'Fdrleft']
z_mat <- fdr_x$mat[,'x']
lfdr_mat <- fdr_x$mat[,'fdr']
dens1_mat <- fdr_x$mat[,'p1f1'] 

id <- which.max(FDR_left[FDR_left < fdr_level])
t_int <- (fdr_level - FDR_left[id])/(FDR_left[id+1] - FDR_left[id])
threshold <- z_mat[id] * (1-t_int) + z_mat[id]*t_int 
lfdr_level <- lfdr_mat[id] * (1-t_int) + lfdr_mat[id]*t_int
cdf_true_positive = sum(dens1_mat[1:id])+ dens1_mat[id+1]* t_int
prop_tp_r <- cdf_true_positive/sum(dens1_mat)
```

The threshold for a local fdr of 20% is `r fdr_x$z.2[1]`. If we want to control the FDR for 10%, we have to find the value on the x-axis for which the left FDR - graph is equal to 10%. The threshold for the z-values using interpolation on the points of the left FDR-graph becomes: `r round(threshold,3)`.

The third graph returns the probability that a non-null gene can be detected when the nominal local fdr is set at a given local fdr-level. The local fdr-level associated with an FDR of 10% is `round(100* lfdr_level,1)` percent which means that we expect `r round(100*prop_tp_r)` percent of all differentiated genes to be correctly identified.   

```{r lfdr_genes}

t_stats <- t_stats %>%
  mutate(
    lfdr = fdr_x$fdr,
    zfdr = (lfdr < lfdr_level) * z_val,
    isdetected_lfdr = factor(lfdr < lfdr_level,
                        levels= c(TRUE,FALSE),
                        labels = c('detected','H0 not rejected')))
summ_lfdr <- t_stats %>%
  filter(lfdr < lfdr_level) %>%
  summarize(nr_of_genes=n(), mean_lfdr=mean(lfdr))

ggplot(t_stats) + 
  scale_fill_manual(values=c("firebrick","lightblue")) +
  geom_histogram(mapping=aes(x = stat, fill=isdetected_lfdr), bins = 20,alpha = .7)+
  labs(title= 't-statistics for differentiated genes Local FDR')+
  theme_bw()       
lfdr_genes <- t_stats %>% filter(lfdr < lfdr_level)%>% .$gene
```

We have found `r summ_lfdr$nr_of_genes` candidates for differentiated genes. The mean local fdr the detected genes is `r round(100*summ_lfdr$mean_lfdr,1)` percent, which means we expect to have `r round(summ_lfdr$mean_lfdr* summ_lfdr$nr_of_genes)` falsely detected genes. The genes detected by the of the local fdr will be added as an appendix.  

## Model Selection

## Model Evaluation

## Conclusions


## References
<div id="refs"></div>

## Appendix: Names of candidate differentiated genes
`r lfdr_genes`
